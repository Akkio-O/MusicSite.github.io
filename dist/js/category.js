import{displayOptions}from"./modules/items/searchItems.mjs";import{loadData,showCategories,filterData,updateItemsDisplay,addSortEventListeners,handleCategoryClicks,dropdownItemCategory,dropdownSubCategory,dropdownCategory}from"./modules/items/filterItems.mjs";const CategoryDropdown=document.querySelector("#category_menu__profiles__CategoryText"),SubCategoryDropdown=document.querySelector("#category_menu__profiles__SubCategoryText"),SubSubCategoryDropdown=document.querySelector("#category_menu__profiles__subSubCategoryText"),instruments=[],search=document.querySelector(".search"),searchOptions=document.querySelector(".options"),formSearch=document.querySelector(".promo_search__form"),searchIcon=formSearch.querySelector("i");let dataLoaded=!1;async function fetchData(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Ошибка HTTP: "+t.status);const o=await t.json();instruments.push(...o),console.log("Данные успешно загружены:",instruments),dataLoaded=!0}catch(e){console.error("Произошла ошибка при загрузке данных:",e)}}function handleSearch(){const e=search.value.trim();if(e){const t=`http://localhost:8080/search?text=${encodeURIComponent(e)}`;window.open(t,"_blank")}}search.addEventListener("input",(function(){const e=this.value;displayOptions(e,instruments)})),search.addEventListener("click",(function(){dataLoaded||fetchData("http://localhost:8080/getProductsData")})),document.addEventListener("click",(function(e){formSearch.contains(e.target)||(search.value="",searchOptions.innerHTML="",searchOptions.style.backgroundColor="transparent")})),search.addEventListener("keydown",(function(e){"Enter"===e.key&&handleSearch()})),searchIcon.addEventListener("click",handleSearch);const urlParams=new URLSearchParams(window.location.search),searchToText=urlParams.get("text"),searchToProduct=urlParams.get("search"),categorylink=urlParams.get("category"),subcategorylink=urlParams.get("subcategory"),subsubcategorylink=urlParams.get("subsubcategory"),asc=document.getElementById("sort-asc"),desc=document.getElementById("sort-desc");async function main(){try{const e=await loadData("http://localhost:8080/getProductsData");showCategories(e),categorylink&&(CategoryDropdown.textContent=categorylink,dropdownCategory(e,categorylink)),subcategorylink&&(SubCategoryDropdown.textContent=subcategorylink,dropdownSubCategory(e,categorylink,subcategorylink)),subsubcategorylink&&(SubSubCategoryDropdown.textContent=subsubcategorylink,dropdownItemCategory(e,categorylink,subcategorylink,subsubcategorylink)),document.querySelector("#categoryDropdown").classList.remove("show"),document.querySelector("#subCategoryDropdown").classList.remove("show"),document.querySelector("#subSubCategoryDropdown").classList.remove("show");let t=filterData(e,categorylink,subcategorylink,subsubcategorylink,searchToText,searchToProduct);addSortEventListeners(t),updateItemsDisplay(t),CategoryDropdown.addEventListener("click",(function(){document.querySelector("#categoryDropdown").classList.toggle("show")})),SubCategoryDropdown.addEventListener("click",(function(){document.querySelector("#subCategoryDropdown").classList.toggle("show")})),SubSubCategoryDropdown.addEventListener("click",(function(){document.querySelector("#subSubCategoryDropdown").classList.toggle("show")})),window.addEventListener("click",(function(e){e.target===asc||e.target===desc?e.preventDefault():handleCategoryClicks(e,t)}))}catch(e){console.error("Произошла ошибка:",e)}}async function handleSubmitButtonClick(e){let t=document.getElementById("fileInput").files[0];if(!t)return void console.error("Файл не выбран.");let o=new FormData;o.append("file",t);const r=new WebSocket("ws://localhost:8080/progress");r.onopen=function(){console.log("WebSocket подключение установлено.")},r.onclose=function(){console.log("WebSocket подключение закрыто.")},r.onerror=function(e){console.error("WebSocket ошибка:",e)},r.onmessage=function(e){let t=JSON.parse(e.data).progress;document.getElementById("fileUploadProgress").value=t};let n=new XMLHttpRequest;n.addEventListener("load",(function(e){n.status>=200&&n.status<300?(console.log("Файл успешно загружен на сервер."),r.close()):console.error("Произошла ошибка при загрузке файла на сервер.")})),n.open("POST","http://localhost:8080/fileExcel"),n.send(o)}main(),document.querySelector("#fileInput").addEventListener("change",(function(e){let t=e.target.files[0];e.target.closest(".input-file").querySelector(".input-file-text").innerHTML=t.name})),document.querySelector(".xlsxFileSubmit").addEventListener("click",handleSubmitButtonClick);